version: 2.1
references:
  test: &test
    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true
      - run: docker info
      - run: |
          set -x
          docker volume create project
          docker create -v project:/app --name project busybox chown -R 1000:1000 /app
          docker cp . project:/app
          docker start project
          docker-compose build $SERVICE_NAME
          docker-compose run -e BUNDLE_GEMFILE=$BUNDLE_GEMFILE $SERVICE_NAME bundle install
          docker-compose run -e BUNDLE_GEMFILE=$BUNDLE_GEMFILE $SERVICE_NAME bundle exec rake
jobs:
  test-ruby-2-4--rails-4-2:
    <<: *test
    docker:
      - image: tmaier/docker-compose
        environment:
          COMPOSE_FILE: docker-compose.yml:docker-compose.ci.yml
          SERVICE_NAME: ruby-2-4
          BUNDLE_GEMFILE: /app/gemfiles/rails4_2.gemfile
  test-ruby-2-4--rails-5-0:
    <<: *test
    docker:
      - image: tmaier/docker-compose
        environment:
          COMPOSE_FILE: docker-compose.yml:docker-compose.ci.yml
          SERVICE_NAME: ruby-2-4
          BUNDLE_GEMFILE: /app/gemfiles/rails5_0.gemfile
  test-ruby-2-4--rails-5-1:
    <<: *test
    docker:
      - image: tmaier/docker-compose
        environment:
          COMPOSE_FILE: docker-compose.yml:docker-compose.ci.yml
          SERVICE_NAME: ruby-2-4
          BUNDLE_GEMFILE: /app/gemfiles/rails5_1.gemfile
  test-ruby-2-5--rails-4-2:
    <<: *test
    docker:
      - image: tmaier/docker-compose
        environment:
          COMPOSE_FILE: docker-compose.yml:docker-compose.ci.yml
          SERVICE_NAME: ruby-2-5
          BUNDLE_GEMFILE: /app/gemfiles/rails4_2.gemfile
  test-ruby-2-5--rails-5-0:
    <<: *test
    docker:
      - image: tmaier/docker-compose
        environment:
          COMPOSE_FILE: docker-compose.yml:docker-compose.ci.yml
          SERVICE_NAME: ruby-2-5
          BUNDLE_GEMFILE: /app/gemfiles/rails5_0.gemfile
  test-ruby-2-5--rails-5-1:
    <<: *test
    docker:
      - image: tmaier/docker-compose
        environment:
          COMPOSE_FILE: docker-compose.yml:docker-compose.ci.yml
          SERVICE_NAME: ruby-2-5
          BUNDLE_GEMFILE: /app/gemfiles/rails5_1.gemfile
  test-ruby-2-6--rails-4-2:
    <<: *test
    docker:
      - image: tmaier/docker-compose
        environment:
          COMPOSE_FILE: docker-compose.yml:docker-compose.ci.yml
          SERVICE_NAME: ruby-2-6
          BUNDLE_GEMFILE: /app/gemfiles/rails4_2.gemfile
  test-ruby-2-6--rails-5-0:
    <<: *test
    docker:
      - image: tmaier/docker-compose
        environment:
          COMPOSE_FILE: docker-compose.yml:docker-compose.ci.yml
          SERVICE_NAME: ruby-2-6
          BUNDLE_GEMFILE: /app/gemfiles/rails5_0.gemfile
  test-ruby-2-6--rails-5-1:
    <<: *test
    docker:
      - image: tmaier/docker-compose
        environment:
          COMPOSE_FILE: docker-compose.yml:docker-compose.ci.yml
          SERVICE_NAME: ruby-2-6
          BUNDLE_GEMFILE: /app/gemfiles/rails5_1.gemfile
workflows:
  version: 2
  test_and_buld:
    jobs:
      - test-ruby-2-4--rails-4-2
      - test-ruby-2-4--rails-5-0
      - test-ruby-2-4--rails-5-1
      - test-ruby-2-5--rails-4-2
      - test-ruby-2-5--rails-5-0
      - test-ruby-2-5--rails-5-1
      - test-ruby-2-6--rails-4-2
      - test-ruby-2-6--rails-5-0
      - test-ruby-2-6--rails-5-1
