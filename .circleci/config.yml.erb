version: 2.1
references:
  test: &test
    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true
      - run: docker info
      - run: |
          set -x
          docker volume create project
          docker create -v project:/app --name project busybox chown -R 1000:1000 /app
          docker cp . project:/app
          docker start project
          docker-compose build $SERVICE_NAME
          docker-compose run -e BUNDLE_GEMFILE=$BUNDLE_GEMFILE $SERVICE_NAME bundle install
          docker-compose run -e BUNDLE_GEMFILE=$BUNDLE_GEMFILE $SERVICE_NAME bundle exec rake
jobs:
<%- data['ruby_versions'].product(data['rails_versions']).each do |ruby_version, rails_version| -%>
  test-ruby-<%= ruby_version.tr('.', '-') %>--rails-<%= rails_version.tr('.', '-') %>:
    <<: *test
    docker:
      - image: tmaier/docker-compose
        environment:
          COMPOSE_FILE: docker-compose.yml:docker-compose.ci.yml
          SERVICE_NAME: ruby-<%= ruby_version.tr('.', '-') %>
          BUNDLE_GEMFILE: /app/gemfiles/rails<%= rails_version.tr('.', '_') %>.gemfile
<%- end -%>
workflows:
  version: 2
  test_and_buld:
    jobs:
<%- data['ruby_versions'].product(data['rails_versions']).each do |ruby_version, rails_version| -%>
      - test-ruby-<%= ruby_version.tr('.', '-') %>--rails-<%= rails_version.tr('.', '-') %>
<%- end -%>
